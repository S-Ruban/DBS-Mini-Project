CREATE DATABASE FODS;
\c fods

CREATE DOMAIN RATING AS INTEGER CHECK (VALUE BETWEEN 1 AND 5);

CREATE TABLE USERS (
    Uname VARCHAR(20) PRIMARY KEY,
    Pass VARCHAR NOT NULL,
    FirstName VARCHAR(30) NOT NULL,
    LastName VARCHAR(30),
    Phone VARCHAR(10) NOT NULL,
    Email VARCHAR NOT NULL
);

CREATE TABLE CUSTOMERS (
    Cust_Uname VARCHAR(20) PRIMARY KEY,
    ALine1 VARCHAR(100) NOT NULL,
    ALine2 VARCHAR(100),
    City VARCHAR(50) NOT NULL,
    Pin VARCHAR(6) NOT NULL,
	Lat NUMERIC NOT NULL,
	Long NUMERIC NOT NULL
);

CREATE TABLE RESTAURANTS (
	Rest_Uname VARCHAR(20) NOT NULL,
	FSSAI VARCHAR(14) PRIMARY KEY,
	Rest_Name VARCHAR(50) NOT NULL,
	Img_Link VARCHAR,
	ALine1 VARCHAR(100) NOT NULL,
	ALine2 VARCHAR(100),
	City VARCHAR(50) NOT NULL,
	Pin NUMERIC(6) NOT NULL,
	Lat NUMERIC NOT NULL,
	Long NUMERIC NOT NULL,
	isOpen BOOLEAN NOT NULL,
	isVeg BOOLEAN NOT NULL
);

CREATE TABLE RESTAURANT_PHONE (
	FSSAI VARCHAR(14) NOT NULL,
	Phone VARCHAR(10) PRIMARY KEY
);

CREATE TABLE DELIVERY_PERSONS (
	Del_Uname VARCHAR(20) PRIMARY KEY,
	VNo VARCHAR(20) NOT NULL,
	VModel VARCHAR(30) NOT NULL,
	VColour VARCHAR(15) NOT NULL,
	isAvail BOOLEAN NOT NULL,
	Lat NUMERIC NOT NULL,
	Long NUMERIC NOT NULL
);

CREATE TABLE FOOD_ITEMS (
	ItemNo INTEGER NOT NULL,
	FSSAI VARCHAR(14) NOT NULL,
	ItemName VARCHAR(32) NOT NULL,
	Img_Link VARCHAR,
	ItemDesc VARCHAR(1024),
	IsAvail BOOLEAN NOT NULL,
	IsVeg BOOLEAN NOT NULL,
	Cuisine VARCHAR(20) NOT NULL,
	Mealtype VARCHAR(20) NOT NULL,
	Price NUMERIC NOT NULL,
    PRIMARY KEY (ItemNo, FSSAI)
);

CREATE TABLE ORDERS (
	OrderNo SERIAL PRIMARY KEY,
	OrderTime TIMESTAMP NOT NULL,
    IsPlaced BOOLEAN NOT NULL,
	IsAssigned BOOLEAN NOT NULL,
	IsPrepared BOOLEAN NOT NULL,
	IsReceived BOOLEAN NOT NULL,
	IsDelivered BOOLEAN NOT NULL,
	IsPaid BOOLEAN NOT NULL,
	Cust_Uname VARCHAR(20) NOT NULL,
	FSSAI VARCHAR(14) NOT NULL,
	Del_Uname VARCHAR(20),
	Del_Charge NUMERIC
);

CREATE TABLE ORDER_CONTENTS (
	OrderNo INTEGER NOT NULL,
	ItemNo INTEGER NOT NULL,
	FSSAI VARCHAR(14) NOT NULL,
	Quantity NUMERIC NOT NULL,
    PRIMARY KEY (OrderNo, ItemNo, FSSAI)
);

CREATE TABLE RATINGS (
	FSSAI VARCHAR(14) NOT NULL,
	Cust_Uname VARCHAR(20) NOT NULL,
	ReviewTime TIMESTAMP NOT NULL,
	Rating RATING NOT NULL,
	Review VARCHAR,
	PRIMARY KEY (FSSAI, Cust_Uname)
);

ALTER TABLE CUSTOMERS ADD CONSTRAINT FK_CUser FOREIGN KEY (Cust_Uname) REFERENCES USERS (Uname) ON DELETE CASCADE;
ALTER TABLE RESTAURANTS ADD CONSTRAINT FK_RUser FOREIGN KEY (Rest_Uname) REFERENCES USERS (Uname) ON DELETE CASCADE;
ALTER TABLE DELIVERY_PERSONS ADD CONSTRAINT FK_DUser FOREIGN KEY (Del_Uname) REFERENCES USERS (Uname) ON DELETE CASCADE;
ALTER TABLE RESTAURANT_PHONE ADD CONSTRAINT FK_RPhone FOREIGN KEY (FSSAI) REFERENCES RESTAURANTS (FSSAI) ON DELETE CASCADE;
ALTER TABLE FOOD_ITEMS ADD CONSTRAINT FK_Rest_Food FOREIGN KEY (FSSAI) REFERENCES RESTAURANTS (FSSAI) ON DELETE CASCADE;
ALTER TABLE ORDERS ADD CONSTRAINT FK_COrder FOREIGN KEY (Cust_Uname) REFERENCES CUSTOMERS (Cust_Uname) ON DELETE CASCADE;
ALTER TABLE ORDERS ADD CONSTRAINT FK_ROrder FOREIGN KEY (FSSAI) REFERENCES RESTAURANTS (FSSAI) ON DELETE CASCADE;
ALTER TABLE ORDERS ADD CONSTRAINT FK_DOrder FOREIGN KEY (Del_Uname) REFERENCES DELIVERY_PERSONS (Del_Uname) ON DELETE CASCADE;
ALTER TABLE ORDER_CONTENTS ADD CONSTRAINT FK_OrderNo FOREIGN KEY (OrderNo)	REFERENCES ORDERS (OrderNo) ON DELETE CASCADE;
ALTER TABLE ORDER_CONTENTS ADD CONSTRAINT FK_FoodItem FOREIGN KEY (ItemNo, FSSAI) REFERENCES FOOD_ITEMS (ItemNo, FSSAI) ON DELETE CASCADE;
ALTER TABLE RATINGS ADD CONSTRAINT FK_Rating_Rest FOREIGN KEY (FSSAI) REFERENCES RESTAURANTS (FSSAI) ON DELETE CASCADE;
ALTER TABLE RATINGS ADD CONSTRAINT FK_Rating_Cust FOREIGN KEY (Cust_Uname) REFERENCES CUSTOMERS (Cust_Uname) ON DELETE CASCADE;

CREATE OR REPLACE FUNCTION IS_VALID_ITEM (OrderNo INTEGER, FSSAI VARCHAR(14))
RETURNS BOOLEAN
LANGUAGE PLPGSQL AS
$$
BEGIN
	RETURN ($2 = (SELECT O.FSSAI FROM ORDERS O WHERE O.OrderNo = $1));
END
$$;

ALTER TABLE ORDER_CONTENTS ADD CONSTRAINT SameRest CHECK (IS_VALID_ITEM(OrderNo, FSSAI));

CREATE TABLE USER_SESSIONS (
	sid VARCHAR NOT NULL COLLATE "default",
	sess JSON NOT NULL,
	expire TIMESTAMP(6) NOT NULL
) WITH (OIDS=FALSE);
ALTER TABLE USER_SESSIONS ADD CONSTRAINT session_pkey PRIMARY KEY (sid) NOT DEFERRABLE INITIALLY IMMEDIATE;
CREATE INDEX "IDX_session_expire" ON USER_SESSIONS (expire);